echo "ğŸš€ Running pre-push checks..."

# Check if dev server is running (required for E2E tests)
if ! curl -s http://localhost:3001 > /dev/null 2>&1; then
  echo "âŒ Error: Dev server not running on port 3001"
  echo "ğŸ’¡ Start dev server in another terminal: pnpm dev"
  echo "ğŸ’¡ Verify dev server is ready: curl http://localhost:3001"
  echo "ğŸ’¡ Then retry your push"
  exit 1
fi

echo "âœ… Dev server is running on port 3001"

# Check if full test suite is requested via environment variable
if [ "$PRE_PUSH_FULL_TESTS" = "true" ]; then
  echo "ğŸ§ª Running full E2E test suite..."
  pnpm test || {
    echo "âŒ Tests failed. Please fix them before pushing."
    echo "ğŸ’¡ Tip: Run 'pnpm test' locally to debug"
    exit 1
  }
else
  # Run critical E2E tests (auth and race-import)
  echo "ğŸ§ª Running critical E2E tests..."
  pnpm test:critical || {
    echo "âŒ Critical tests failed. Please fix them before pushing."
    echo "ğŸ’¡ Tip: Run 'pnpm test:critical' locally to debug"
    echo "ğŸ’¡ Tip: Set PRE_PUSH_FULL_TESTS=true to run full test suite"
    exit 1
  }
fi

# Build check (ensures production build works)
echo "ğŸ—ï¸  Checking build..."
pnpm build || {
  echo "âŒ Build failed. Please fix build errors before pushing."
  exit 1
}

echo "âœ… All pre-push checks passed! ğŸ‰"