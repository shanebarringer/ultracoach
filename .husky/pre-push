echo "ğŸš€ Running pre-push checks..."

# Check if dev server is running on port 3001
SERVER_RUNNING=false
if lsof -ti:3001 > /dev/null 2>&1; then
  echo "âœ… Dev server already running on port 3001"
  SERVER_RUNNING=true
else
  echo "ğŸŒ Dev server not running, starting it..."

  # Set up cleanup trap to kill background server on script exit
  # This ensures the dev server is stopped even if tests or build fail
  trap 'if [ -n "$SERVER_PID" ] && kill -0 "$SERVER_PID" 2>/dev/null; then kill "$SERVER_PID" 2>/dev/null || true; fi' EXIT INT TERM

  # Start dev server in background
  pnpm dev > /tmp/ultracoach-dev-server.log 2>&1 &
  SERVER_PID=$!
  echo "ğŸ“ Dev server started with PID: $SERVER_PID"

  # Wait for server to be ready (max 60 seconds)
  echo "â³ Waiting for dev server to be ready..."
  for i in {1..60}; do
    if lsof -ti:3001 > /dev/null 2>&1; then
      echo "âœ… Dev server is ready!"
      # Brief stabilization delay to avoid race conditions
      sleep 1
      SERVER_RUNNING=true
      break
    fi
    sleep 1
    echo "   Attempt $i/60..."
  done

  if [ "$SERVER_RUNNING" = false ]; then
    echo "âŒ Dev server failed to start within 60 seconds"
    echo "ğŸ’¡ Check logs at /tmp/ultracoach-dev-server.log"
    kill $SERVER_PID 2>/dev/null || true
    exit 1
  fi
fi

# Function to restart dev server (used for auto-recovery from corrupted server state)
restart_dev_server() {
  echo "ğŸ”„ Restarting dev server for auto-recovery..."

  # Kill any process on port 3001
  if lsof -ti:3001 > /dev/null 2>&1; then
    echo "   Killing existing server on port 3001..."
    lsof -ti:3001 | xargs kill -9 2>/dev/null || true
    sleep 2
  fi

  # Start fresh server
  echo "   Starting fresh dev server..."
  pnpm dev > /tmp/ultracoach-dev-server.log 2>&1 &
  SERVER_PID=$!
  echo "   Server started with PID: $SERVER_PID"

  # Set up cleanup trap for new server
  trap 'if [ -n "$SERVER_PID" ] && kill -0 "$SERVER_PID" 2>/dev/null; then kill "$SERVER_PID" 2>/dev/null || true; fi' EXIT INT TERM

  # Wait for server to be ready (max 30 seconds)
  echo "   Waiting for server to be ready..."
  for i in {1..30}; do
    if lsof -ti:3001 > /dev/null 2>&1; then
      echo "   âœ… Server ready!"
      sleep 2  # Extra stabilization time for fresh server
      return 0
    fi
    sleep 1
  done

  echo "   âŒ Server failed to start"
  return 1
}

# Check if full test suite is requested via environment variable
if [ "$PRE_PUSH_FULL_TESTS" = "true" ]; then
  echo "ğŸ§ª Running full E2E test suite..."
  if ! pnpm test; then
    echo "âš ï¸  Tests failed - this might be due to corrupted dev server state"
    echo "ğŸ”„ Attempting automatic recovery: restarting dev server..."

    # Restart server and retry tests once
    if restart_dev_server; then
      echo "ğŸ§ª Retrying full test suite with fresh server..."
      if pnpm test; then
        echo "âœ… Tests passed after server restart!"
      else
        echo "âŒ Tests still failing after server restart"
        echo "ğŸ’¡ This indicates a real test failure, not server corruption"
        echo "ğŸ’¡ Run 'pnpm test' locally to debug"
        exit 1
      fi
    else
      echo "âŒ Failed to restart dev server"
      exit 1
    fi
  fi
else
  # Run critical E2E tests (auth and race-import)
  echo "ğŸ§ª Running critical E2E tests..."
  if ! pnpm test:critical; then
    echo "âš ï¸  Tests failed - this might be due to corrupted dev server state"
    echo "ğŸ”„ Attempting automatic recovery: restarting dev server..."

    # Restart server and retry tests once
    if restart_dev_server; then
      echo "ğŸ§ª Retrying critical tests with fresh server..."
      if pnpm test:critical; then
        echo "âœ… Tests passed after server restart!"
      else
        echo "âŒ Tests still failing after server restart"
        echo "ğŸ’¡ This indicates a real test failure, not server corruption"
        echo "ğŸ’¡ Run 'pnpm test:critical' locally to debug"
        echo "ğŸ’¡ Tip: Set PRE_PUSH_FULL_TESTS=true to run full test suite"
        exit 1
      fi
    else
      echo "âŒ Failed to restart dev server"
      exit 1
    fi
  fi
fi

# Build check (ensures production build works)
echo "ğŸ—ï¸  Checking build..."
pnpm build || {
  echo "âŒ Build failed. Please fix build errors before pushing."
  exit 1
}

echo "âœ… All pre-push checks passed! ğŸ‰"