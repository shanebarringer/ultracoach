# CI Workflow for UltraCoach
#
# Prerequisites:
# - Set BETTER_AUTH_SECRET in GitHub repository secrets (64+ char hex string)
# - If not set, falls back to a test secret for CI (less secure but functional)
#
# To set the secret:
# 1. Go to GitHub repo → Settings → Secrets and variables → Actions
# 2. Add BETTER_AUTH_SECRET with a secure 64+ character hex string
# 3. Generate with: openssl rand -hex 32

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  vitest:
    runs-on: ubuntu-latest
    env:
      # Required for Better Auth tests - use GitHub secret or generate one for CI
      BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET || 'ci_test_secret_1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef' }}
      NODE_ENV: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: Install dependencies
        run: pnpm install

      - name: Run Vitest tests
        run: pnpm test:run

  playwright:
    # Run Playwright on main branch pushes and PR to fix/playwright-ci-tests branch
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.head_ref == 'fix/playwright-ci-tests' && github.event_name == 'pull_request')
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: ultracoach_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      # Test database configuration
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/ultracoach_test
      NODE_ENV: test

      # Test user credentials
      TEST_COACH_EMAIL: testcoach@ultracoach.dev
      TEST_COACH_PASSWORD: TestCoach123!
      TEST_RUNNER_EMAIL: testrunner@ultracoach.dev
      TEST_RUNNER_PASSWORD: TestRunner123!

      # Auth configuration - use GitHub secret or generate one for CI
      BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET || 'ci_test_secret_1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef' }}
      BETTER_AUTH_URL: http://localhost:3001

      # Email configuration (test mode)
      RESEND_API_KEY: test-key
      RESEND_FROM_EMAIL: test@ultracoach.dev

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: Install dependencies
        run: pnpm install

      - name: Set up test database schema
        run: |
          echo "Setting up test database schema..."
          # Apply all database migrations in order
          for migration in supabase/migrations/*.sql; do
            echo "Applying migration: $migration"
            PGPASSWORD=postgres psql -h localhost -U postgres -d ultracoach_test -f "$migration"
          done
          echo "Database schema setup complete"

      - name: Seed test database
        run: pnpm test:db:seed

      - name: Install Playwright browsers
        run: pnpm exec playwright install chromium --with-deps

      - name: Run Playwright tests
        run: pnpm test:e2e

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload test screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots
          path: test-results/
          retention-days: 30
